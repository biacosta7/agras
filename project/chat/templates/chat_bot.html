{% extends 'base.html' %} 
{% load static %}
{% block title %}Chat{% endblock %}

{% block content %}
<body class="font-sans bg-white h-screen flex flex-col">
    <div class="flex-none bg-white shadow-md p-4">
        <h1 class="text-3xl font-bold text-center">Chat Gemini ðŸŒ±</h1>
    </div>

    <div id="chat-history" class="flex-grow bg-white shadow-md rounded-lg ml-20 mr-20 mt-8 p-4 overflow-y-auto max-h-[calc(100vh-200px)]">

        <!-- HistÃ³rico de mensagens -->
        {% for chat in chats %}
            <div class="message user-message my-2 p-3 rounded-lg bg-blue-100 text-right">
                <strong>VocÃª:</strong> {{ chat.text_input }}
            </div>
            <div class="message bot-message my-2 p-3 rounded-lg bg-green-100 text-left">
                <strong>IA:</strong>
                <div class="whitespace-pre-wrap">{% autoescape off %}{{ chat.gemini_output }}{% endautoescape %}</div>
            </div>
        {% endfor %}
    </div>
    <!-- FormulÃ¡rio para enviar novas perguntas -->
    <div class="flex-none p-4 ml-20 mr-20">
        <div class="flex items-center justify-center">
            <input type="text" id="user-input" placeholder="Digite sua pergunta..."
                class="w-1/2 p-2 border border-gray-300 bg-slate-100 rounded-xl focus:outline-none focus:ring focus:ring-blue-200"
                required>
            <button onclick="sendMessage()"
                    class="ml-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring focus:ring-blue-200">
                Enviar
            </button>
        </div>
    </div>
</body>

<script>
    function sendMessage() {
        const userInput = document.getElementById("user-input");
        const messageText = userInput.value.trim();

        if (!messageText) return;

        // URL dinÃ¢mica com community_id e user_id
        fetch("{% url 'ask_question' community_id=community_id user_id=user_id %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: new URLSearchParams({ text: messageText })
        })
        .then(response => response.json())
        .then(data => {
            const chatHistory = document.getElementById("chat-history");

            // Adiciona a mensagem do usuÃ¡rio no histÃ³rico
            const userMessage = document.createElement("div");
            userMessage.classList.add("message", "user-message");
            userMessage.innerHTML = `<strong>VocÃª:</strong> ${messageText}`;
            chatHistory.appendChild(userMessage);

            // Adiciona a resposta do bot no histÃ³rico
            const botMessage = document.createElement("div");
            botMessage.classList.add("message", "bot-message");
            botMessage.innerHTML = `<strong>Bot:</strong> ${data.data.text}`;
            chatHistory.appendChild(botMessage);

            // Limpa o campo de entrada de texto
            userInput.value = "";
            chatHistory.scrollTop = chatHistory.scrollHeight; // Rolagem automÃ¡tica para a Ãºltima mensagem
        })
        .catch(error => console.error("Erro ao enviar mensagem:", error));
    }
</script>
{% endblock content %}
