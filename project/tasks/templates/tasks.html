{% extends "base.html" %} {% load static %} {% block title %}
Tarefas {{ community.name }}{% endblock %} 
{% block extra_css %}
<link rel="stylesheet" href="{% static 'tasks/css/variables.css' %}" />
<link rel="stylesheet" href="{% static 'tasks/css/calendar.css' %}" />
{% endblock extra_css %}
{% block content %}
<div class="flex-1 p-6 fade-down lg:p-10 ml:0 lg:ml-[250px] mt-12 lg:mt-[60px]">
  <div class="flex md:flex-row flex-col justify-between mt-4">
    {% include 'modal_create_task.html' %} {% include 'modal_edit_task.html' %}
    {% if tasks %}
    <header class="mb-6">
      <h1 class="text-[44px] lg:text-[48px] font-semibold mt-2">
        Gerenciar <span class="font-medium">tarefas</span>
      </h1>
    </header>
    
    <div class="flex flex-row items-center space-x-6">
      <div class="relative max-w-[411px]">
        <input
          type="text"
          placeholder="Pesquise por tarefas..."
          class="w-full rounded-[8px] bg-[#F5F5F7] shadow-sm py-2 px-4 pl-10 focus:outline-none"
        />
        <span
          class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 material-icons text-[#8ABF17] cursor-pointer"
          >search</span
        >
      </div>
      <button
        id="addArea"
        class="bg-[#8ABF17] text-white font-semibold flex items-center justify-center rounded-[9px] hover:bg-[#7cad10] hover:text-[#edf0e9] h-[50px] px-4"
        onclick="toggleModal('create')"
      >
        <span class="text-3xl items-center mr-2">+</span> Adicionar Tarefa
      </button>
    </div>
  </div>

  <div class="w-full overflow-x-auto">
    <div class="rounded-lg">
      <div
        class="bg-[#FAFAFA] text-black font-normal py-2 flex items-center justify-between"
      >
        <div class="flex items-center">
          <button
            id="btnList"
            class="flex items-center"
            onclick="showView('list')"
          >
            <span class="material-icons mr-2 text-[17px]">list</span>
            <p class="text-[16px]">Lista</p>
          </button>
          <button
            id="btnCalendar"
            class="flex items-center"
            onclick="showView('calendar')"
          >
            <span class="material-icons mx-4 text-[17px] mr-2"
              >calendar_today</span
            >
            <p class="text-[16px]">Calendário</p>
          </button>
        </div>
      </div>
      <div id="listView" class="">
        <table class="w-full text-sm text-left table-auto">
          <thead
            class="text-xs text-[#5F8C1B] uppercase bg-gray-50 border-t-4 border-[#5F8C1B] border-b-4 border-b-[#D3D3D3]"
          >
            <tr>
              <th scope="col" class="px-6 py-3 font-bold">Descrição</th>
              <th scope="col" class="px-[50px] py-3 font-bold">Status</th>
              <th scope="col" class="px-6 py-3 font-bold">Local</th>
              <th scope="col" class="px-6 py-3 font-bold">Prazo</th>
              <th scope="col" class="px-[38px] py-3 font-bold">Materiais</th>
              <th scope="col" class="px-6 py-3 font-bold">Responsável</th>
            </tr>
          </thead>
          <tbody>
            {% for task in tasks %}
            <tr
              class="bg-[#FAFAFA] border-b border-t border-[#D3D3D3]"
            >
              <td class="px-6 py-4 text-black capitalize">
                {{task.description}}
              </td>
              <div class="relative">
                <td class="px-6 py-4 relative">
                  {% if task.status == 'Pendente' %}
                    <span class="bg-red-700 px-2 py-1 rounded-full text-white cursor-pointer"  id="status-dropdown-{{ task.id }}" onclick="openStatusDropdown({{task.id}})">
                      {{ task.status }}
                    </span>
                  {% elif task.status == 'Progresso' %}
                    <span class="bg-[#562A00] px-2 py-1 -ml-3 rounded-full text-white cursor-pointer text-nowrap"  id="status-dropdown-{{ task.id }}" onclick="openStatusDropdown({{task.id}})">
                      Em {{ task.status }}
                    </span>
                  {% else %}
                    <span class="bg-[#5F8C1B] px-2 py-1 rounded-full cursor-pointer text-white"  id="status-dropdown-{{ task.id }}" onclick="openStatusDropdown({{task.id}})">
                      {{ task.status }}
                    </span>
                  {% endif %}
                  <div id="statusModal-{{ task.id }}" class="hidden absolute top-full left-0 -mt-4 -ml-6 z-10 w-48 bg-white rounded-lg shadow-lg border border-gray-200">
                    <form method="POST" id="status-form-{{ task.id }}" action="{% url 'edit_task_status' community.id task.id %}" class="p-4">
                      {% csrf_token %}
                      <label for="status_change" class="block text-sm font-medium text-gray-700 mb-2">
                        Alterar Status
                      </label>
                      <select
                        id="status_change"
                        name="status"
                        class="w-full bg-gray-50 border border-gray-300 text-gray-700 text-sm rounded-md focus:ring-[#5F8C1B] focus:border-[#5F8C1B] p-2.5"
                        onchange="submitStatusForm({{ task.id }})"
                        required
                      >
                        <option value="" selected disabled hidden>Selecione...</option>
                        {% for value, status in status_choices %}
                        <option value="{{ status }}" {% if task.status == status %}selected{% endif %}>
                          {{ status }}
                        </option>
                        {% endfor %}
                      </select>
                    </form>
                  </div>
                </td>
              </div>
              <td class="px-6 py-4 text-black capitalize">
                {% if task.local == 'seedbed' %}<span class="font-bold"
                  >{{ task.area }}</span
                >
                <br />
                {{ task.seedbed }} {% else %} <p class='font-bold'> {{ task.area }} </p> {% endif %}
              </td>
              <td class="px-6 py-4 text-black">
                <div class="flex flex-col space-y-1">
                  {% if task.days_left == 1 %}
                    <p class="ml-0 ">{{ task.days_left }} dia restante</p>
                    <p class="text-xs text-gray-500">Tarefa {{ task.recurrence }}</p>
                  {% elif task.days_left == 7 %}
                    <p class="ml-0">{{ task.days_left }} dias restantes</p>
                    <p class="text-xs text-gray-500">Tarefa {{ task.recurrence }}</p>
                  {% elif task.days_left == 30 %}
                    <p class="ml-0 ">{{ task.days_left }} dias restantes</p>
                    <p class="text-xs text-gray-500">Tarefa {{ task.recurrence }}</p>
                  {% elif task.days_left == 365 %}
                    <p class="ml-0 ">{{ task.days_left }} dias restantes</p>
                    <p class="text-xs text-gray-500">Tarefa {{ task.recurrence }}</p>
                  {% elif task.days_left == 0 %}
                    <p class="font-semibold text-[#F76711]">Hoje
                      <p class="ml-0 text-xs text-gray-500">Tarefa {{ task.recurrence }}</p>
                    </p>
                  {% else %}
                    <p class="font-semibold text-red-700 uppercase">Expirado</p>
                  {% endif %}
                </div>
              </td>
              <td class="px-6 py-4 text-black">
                <button
                  class="bg-[#8ABF17] text-white font-semibold flex items-center justify-center rounded-[9px] hover:bg-[#7cad10] hover:text-[#edf0e9] h-[40px] px-4 mt-2  hover:scale-[1.01] hover:shadow-md transition-all duration-300"
                  onclick="toggleEditTaskModal({{ task.id }})"
                >
                  Consultar
                </button>
              </td>
              <td class="px-6 py-4 text-black">
                <div class="flex items-center gap-1">
                  {% for user in task.responsible_users.all|slice:":3" %}
                  <div
                    class="w-8 h-8 bg-[#8ABF17] text-[#FFFFFF] flex items-center justify-center rounded-md mr-2 font-bold relative"
                    data-name="{{ user.username }}"
                    title="{{ user.first_name }}"
                    style="z-index: 1; margin-left: -4px"
                  >
                    {{ user.username|slice:":1"|upper }}
                  </div>
                  {% endfor %} {% if task.responsible_users.count > 3 %}
                  <span class="text-sm font-medium text-blue-500"
                    >+ {{ task.responsible_users.count|add:"-3" }} outros</span
                  >
                  {% endif %}
                </div>
              </td>
            </tr>
            {%endfor%}
          </tbody>
        </table>
      </div>
      <div id="calendarView" class="border-t-4 border-[#5F8C1B]">
        {% include 'calendar.html' %}
      </div>
    </div>
    {%else%}
    <div class="text-center w-full mt-[15vh]">
      <div class="flex flex-col items-center justify-center w-full">
        <img
          src="{% static 'assets/esqueci-novo.png' %}"
          alt="Plantas"
          class="w-64 mb-4"
        />
        <h1 class="font-bold text-[24px]">
          Nenhuma tarefa criada na comunidade "{{community.name}}"
        </h1>
        <p class="font-normal text-[16px]">
          Clique no botão abaixo para criar tarefas e visualizá-las
        </p>
        <button
          id="addArea"
          class="bg-[#8ABF17] text-white font-semibold flex items-center justify-center rounded-[9px] mt-2 hover:bg-[#7cad10] hover:text-[#edf0e9] h-[50px] px-4"
          onclick="toggleModal('create')"
        >
          <span class="text-3xl items-center mr-2">+</span> Adicionar Tarefa
        </button>
      </div>
    </div>
    {%endif%}
  </div>
</div>
<script type="module" src="{% static 'tasks/js/showCalendar.js' %}"></script>
<script>
  function openStatusDropdown(taskId) {
    const modal = document.getElementById(`statusModal-${taskId}`);
    const allDropdowns = document.querySelectorAll('[id^="statusModal-"]');
  
    allDropdowns.forEach(dropdown => {
      if (dropdown !== modal) {
        dropdown.classList.add('hidden');
      }
    });
  
    modal.classList.toggle('hidden');
  }
  
  document.addEventListener('click', function(event) {
    const dropdowns = document.querySelectorAll('[id^="statusModal-"]');
    dropdowns.forEach(dropdown => {
      if (!dropdown.contains(event.target) && !event.target.closest('[id^="status-dropdown-"]')) {
        dropdown.classList.add('hidden');
      }
    });
  });
  
  function submitStatusForm(taskId) {
    const form = document.getElementById(`status-form-${taskId}`);
    form.submit();
  }
  function showView(view) {
    const listView = document.getElementById("listView");
    const calendarView = document.getElementById("calendarView");
    const btnList = document.getElementById("btnList");
    const btnCalendar = document.getElementById("btnCalendar");

    if (view === "list") {
      listView.style.display = "flex"; // Corrigido para 'style.display'
      calendarView.style.display = "none";

      btnList.classList.add("font-bold");
      btnCalendar.classList.remove("font-bold");
    } else if (view === "calendar") {
      listView.style.display = "none";
      calendarView.style.display = "block";

      btnList.classList.remove("font-bold");
      btnCalendar.classList.add("font-bold");
    }
  }

  showView("list");
</script>

{% endblock %}
